language: rust
sudo: required
os:
  - linux
  - osx
  - windows
cache: cargo
install:
  - >
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      echo 'before'
      choco --version
      choco install --verbose openssl.light
      choco install --verbose openssl.light
      echo 'after'
    fi
before_script:
  - ./tests/fixtures/tls/make-cert.sh
  - >
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      ./tests/fixtures/tls/install-cert.sh
    else
      sudo ./tests/fixtures/tls/install-cert.sh
    fi
script:
  - cargo build --verbose --all
  - cargo test --verbose --all
  - cargo install --force --path did_it_run
  - ./run-test-scripts.sh
jobs:
  include:
    - stage: style and coverage
      os: linux
      rust: nightly
      cache: cargo
      addons:
        apt:
          packages:
            - libcurl4-openssl-dev
            - libelf-dev
            - libdw-dev
            - cmake
            - gcc
            - binutils-dev
            - libiberty-dev
      before_script:
        - ./tests/fixtures/tls/make-cert.sh
        - sudo ./tests/fixtures/tls/install-cert.sh
        - rustup component add rustfmt-preview
        - rustup component add clippy-preview
      script:
        - cargo test --verbose --all --no-run
        - ./check-style.sh
      after_success:
        - ./.build-scripts/codecov.sh
